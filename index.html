<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ratio</title>
    <!-- MathJax for LaTeX rendering -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .option-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .option-btn:active {
            transform: scale(0.98);
        }
        .menu-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .menu-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15);
        }
        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 text-slate-800">

    <!-- MENU VIEW -->
    <div id="menuView" class="w-full max-w-6xl fade-in">
        <div class="text-center mb-8">
            <h1 class="text-5xl font-extrabold text-slate-800 mb-3 tracking-tight">Ratio</h1>
            <p class="text-slate-600 text-lg">Mastering Ratio</p>
        </div>

        <!-- Name Input Section -->
        <div class="max-w-md mx-auto mb-10">
            <div class="glass-panel p-2 rounded-2xl shadow-sm flex items-center gap-3 px-4">
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <input type="text" id="usernameInput" placeholder="Enter your name" class="w-full bg-transparent border-none focus:ring-0 text-slate-700 font-medium placeholder-slate-400 py-2 outline-none" oninput="saveName()">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 px-4">
            <!-- Simplify Card -->
            <button onclick="startQuiz('simplify')" class="menu-card glass-panel rounded-3xl p-8 shadow-xl border-t-4 border-indigo-500 text-left group relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                    <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 24 24"><path d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                </div>
                <div class="w-12 h-12 bg-indigo-100 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-indigo-600 transition-colors shadow-sm">
                    <svg class="w-6 h-6 text-indigo-600 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                </div>
                <h2 class="text-xl font-bold text-slate-800 mb-2">Simplifying Ratios</h2>
                <p class="text-slate-500 text-sm mb-4 leading-relaxed">Simplifying numbers and converting units (e.g., cm to m).</p>
                <div class="flex items-center text-indigo-600 font-bold text-sm group-hover:translate-x-2 transition-transform">
                    Start <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                </div>
            </button>

            <!-- Combined Card -->
            <button onclick="startQuiz('combined')" class="menu-card glass-panel rounded-3xl p-8 shadow-xl border-t-4 border-pink-500 text-left group relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                    <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 24 24"><path d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path></svg>
                </div>
                <div class="w-12 h-12 bg-pink-100 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-pink-600 transition-colors shadow-sm">
                    <svg class="w-6 h-6 text-pink-600 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path></svg>
                </div>
                <h2 class="text-xl font-bold text-slate-800 mb-2">Combined Ratios</h2>
                <p class="text-slate-500 text-sm mb-4 leading-relaxed">Linking ratios like A:B and B:C to find A:B:C.</p>
                <div class="flex items-center text-pink-600 font-bold text-sm group-hover:translate-x-2 transition-transform">
                    Start <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                </div>
            </button>

            <!-- Application Card -->
            <button onclick="startQuiz('application')" class="menu-card glass-panel rounded-3xl p-8 shadow-xl border-t-4 border-emerald-500 text-left group relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                    <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 24 24"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                </div>
                <div class="w-12 h-12 bg-emerald-100 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-emerald-600 transition-colors shadow-sm">
                    <svg class="w-6 h-6 text-emerald-600 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                </div>
                <h2 class="text-xl font-bold text-slate-800 mb-2">Application</h2>
                <p class="text-slate-500 text-sm mb-4 leading-relaxed">Word problems, map scales, splitting quantities, and revenue.</p>
                <div class="flex items-center text-emerald-600 font-bold text-sm group-hover:translate-x-2 transition-transform">
                    Start <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                </div>
            </button>
        </div>
    </div>

    <!-- QUIZ VIEW -->
    <div id="quizView" class="hidden glass-panel rounded-3xl shadow-2xl w-full max-w-3xl overflow-hidden fade-in relative">
        <!-- Header -->
        <div id="headerBar" class="bg-indigo-600 p-5 text-white flex justify-between items-center shadow-md transition-colors duration-500">
            <div class="flex items-center gap-4">
                <button onclick="showMenu()" class="bg-white/20 hover:bg-white/30 p-2 rounded-xl transition-all hover:scale-105" title="Back to Menu">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </button>
                <div>
                    <h1 id="quizTitle" class="text-xl font-bold tracking-tight">Ratio</h1>
                    <div id="quizSubtitle" class="text-xs opacity-80 uppercase tracking-widest font-semibold">Topic</div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-white/80 font-medium text-sm"><span id="qCount">1</span>/10</div>
                <div class="bg-black/20 px-4 py-2 rounded-xl text-center">
                    <div class="text-[10px] uppercase tracking-wider opacity-75 font-bold">Score</div>
                    <div class="text-xl font-mono font-bold leading-none"><span id="score">0</span></div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="p-6 md:p-8">
            <!-- Question Area -->
            <div class="bg-white border border-slate-200 rounded-2xl p-8 mb-8 flex flex-col items-center justify-center min-h-[180px] text-center shadow-sm relative overflow-hidden">
                <div class="absolute top-0 left-0 w-2 h-full bg-slate-100"></div> 
                <div id="questionText" class="text-slate-500 mb-6 text-sm font-bold uppercase tracking-wide w-full text-center"></div>
                <div id="mathDisplay" class="w-full break-words whitespace-normal text-slate-800 font-medium tracking-tight leading-relaxed">
                    <!-- MathJax will render here -->
                </div>
            </div>

            <!-- Options Grid -->
            <div id="optionsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-6">
                <!-- Buttons injected by JS -->
            </div>

            <!-- Feedback -->
            <div id="feedbackArea" class="hidden rounded-xl p-4 mb-6 text-center text-sm font-bold animate-pulse shadow-inner"></div>

            <!-- Controls -->
            <div class="flex justify-end pt-2">
                <button onclick="nextQuestion()" id="nextBtn" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 px-10 rounded-xl shadow-lg transform transition hover:-translate-y-1 active:translate-y-0 focus:outline-none flex items-center gap-3">
                    <span>Skip Question</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- RESULT VIEW -->
    <div id="resultView" class="hidden w-full max-w-md fade-in">
        <div class="glass-panel rounded-3xl p-8 shadow-2xl text-center">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <h2 class="text-3xl font-extrabold text-slate-800 mb-2">Session Complete!</h2>
            <p class="text-slate-500 mb-8">Great job on practicing ratio.</p>
            
            <div class="bg-white/50 rounded-xl p-6 mb-8 text-left space-y-4">
                <div class="flex justify-between items-center border-b border-slate-200 pb-3">
                    <span class="text-slate-500 font-medium">Student</span>
                    <span id="resultName" class="text-slate-800 font-bold text-lg">Student</span>
                </div>
                <div class="flex justify-between items-center border-b border-slate-200 pb-3">
                    <span class="text-slate-500 font-medium">Score</span>
                    <span class="text-slate-800 font-bold text-lg"><span id="resultScore">0</span> / 10</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-slate-500 font-medium">Time</span>
                    <span id="resultTime" class="text-slate-800 font-bold text-sm">--:--</span>
                </div>
            </div>

            <button onclick="showMenu()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg transform transition hover:-translate-y-1 active:translate-y-0 flex justify-center items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                Back to Menu
            </button>
        </div>
    </div>

<script>
    // --- State ---
    let state = {
        score: 0,
        questionCount: 0,
        maxQuestions: 10,
        isAnswered: false,
        currentTopic: 'simplify',
        studentName: 'Student'
    };

    // --- Math Generators ---
    const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
    const lcm = (a, b) => (a * b) / gcd(a, b);
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
    
    const getSimplestRatio = (a, b) => {
        const div = gcd(a, b);
        return `${a/div} : ${b/div}`;
    };

    const attachUnit = (ratioStr, unit) => {
        const [r1, r2] = ratioStr.split(' : ');
        return `${r1}\\text{ ${unit}} : ${r2}\\text{ ${unit}}`;
    };

    const generators = {
        simplify: () => {
            const isUnitQuestion = Math.random() > 0.4;
            
            if (!isUnitQuestion) {
                const common = rand(2, 12);
                const x = rand(1, 15);
                let y = rand(1, 15);
                while(x === y) y = rand(1, 15);
                const A = x * common;
                const B = y * common;
                const correct = getSimplestRatio(A, B);
                return {
                    q: "Simplify the following ratio:",
                    tex: `${A} : ${B}`,
                    correct: correct,
                    distractors: [
                        getSimplestRatio(B, A),
                        `${Math.floor(A/2)} : ${Math.floor(B/2)}`,
                        `${x+1} : ${y}`
                    ]
                };
            } else {
                const units = [
                    { name: 'm', sub: 'cm', factor: 100 },
                    { name: 'cm', sub: 'mm', factor: 10 },
                    { name: 'km', sub: 'm', factor: 1000 },
                    { name: 'kg', sub: 'g', factor: 1000 },
                    { name: 'L', sub: 'mL', factor: 1000 },
                    { name: 'hour', sub: 'min', factor: 60 },
                    { name: 'min', sub: 'sec', factor: 60 }
                ];
                const u = units[Math.floor(Math.random() * units.length)];
                const direction = Math.random() > 0.5;
                let bigVal = rand(1, 6);
                let smallVal = rand(1, u.factor * bigVal - 1);
                
                if (u.factor >= 100) {
                    smallVal = Math.round(smallVal / 50) * 50;
                    if (smallVal === 0) smallVal = 50;
                } else if (u.factor === 60) {
                    smallVal = Math.round(smallVal / 5) * 5;
                    if (smallVal === 0) smallVal = 5;
                }

                let val1, unit1, val2, unit2, rawVal1, rawVal2;
                if (direction) {
                    val1 = smallVal; unit1 = u.sub;
                    val2 = bigVal; unit2 = u.name + ((bigVal > 1 && u.name !== 'km' && u.name !== 'm' && u.name !== 'cm' && u.name !== 'mm') ? 's' : ''); 
                    rawVal1 = smallVal;
                    rawVal2 = bigVal * u.factor;
                } else {
                    val1 = bigVal; unit1 = u.name + ((bigVal > 1 && u.name !== 'km' && u.name !== 'm' && u.name !== 'cm' && u.name !== 'mm') ? 's' : '');
                    val2 = smallVal; unit2 = u.sub;
                    rawVal1 = bigVal * u.factor;
                    rawVal2 = smallVal;
                }
                
                const numCorrect = getSimplestRatio(rawVal1, rawVal2);
                const numW1 = getSimplestRatio(val1, val2); 
                const numW2 = getSimplestRatio(rawVal2, rawVal1); 
                const numW3 = getSimplestRatio(rawVal1 + 10, rawVal2); 
                
                const correct = attachUnit(numCorrect, u.sub);
                const w1 = attachUnit(numW1, u.sub);
                const w2 = attachUnit(numW2, u.sub);
                const w3 = attachUnit(numW3, u.sub);

                return {
                    q: "Simplify the ratio:",
                    tex: `\\text{${val1} ${unit1} : ${val2} ${unit2}}`,
                    correct: correct,
                    distractors: [w1, w2, w3]
                };
            }
        },
        combined: () => {
            const x = rand(1, 7);
            const y = rand(1, 8); 
            const u = rand(1, 8); 
            const v = rand(1, 7);
            const commonB = lcm(y, u);
            const scale1 = commonB / y;
            const scale2 = commonB / u;
            const A = x * scale1;
            const B = commonB;
            const C = v * scale2;
            const div = gcd(A, gcd(B, C));
            const finalA = A/div;
            const finalB = B/div;
            const finalC = C/div;
            const correct = `${finalA} : ${finalB} : ${finalC}`;
            const w1 = `${x} : ${Math.max(y, u)} : ${v}`;
            const w2 = `${x} : ${y*u} : ${v}`;
            const w3 = `${finalA} : ${Math.floor((y+u)/2)} : ${finalC}`;
            
            // Used array environment to force vertical separation
            const qTex = `\\begin{array}{c} \\text{Given } a:b = ${x}:${y} \\text{ and } b:c = ${u}:${v} \\\\[1em] \\text{Find } a:b:c \\end{array}`;

            return {
                q: "Find the combined ratio:",
                tex: qTex,
                correct: correct,
                distractors: [w1, w2, w3]
            };
        },

        // Application Generator
        application: () => {
            const type = Math.floor(Math.random() * 6);
            
            if (type === 0) {
                // ALLOCATION
                const contexts = [
                    { name: 'piece of ribbon', unit: 'm', action: 'cut into', subject: 'piece' },
                    { name: 'sum of money', unit: '$', action: 'divided in', subject: 'share' },
                    { name: 'bag of flour', unit: 'kg', action: 'divided in', subject: 'share' }
                ];
                const ctx = pick(contexts);
                
                const a = rand(2, 6);
                const b = rand(2, 6);
                const c = rand(2, 6);
                const totalParts = a + b + c;
                
                const k = rand(2, 12) * (ctx.unit === 'm' ? 0.5 : 10);
                const Total = totalParts * k;
                
                const findLargest = Math.random() > 0.5;
                const targetPart = findLargest ? Math.max(a, b, c) : Math.min(a, b, c);
                const ans = targetPart * k;
                const adjective = findLargest ? (ctx.unit === 'm' ? 'longest' : 'largest') : (ctx.unit === 'm' ? 'shortest' : 'smallest');
                
                const totalStr = parseFloat(Total.toFixed(1));
                const ansStr = parseFloat(ans.toFixed(1));
                
                const fmt = (val, u) => u === '$' ? `$${val}` : `${val} ${u}`;

                const qText = `A ${ctx.name} is ${fmt(totalStr, ctx.unit)}.<br><br>It is ${ctx.action} the ratio ${a} : ${b} : ${c}.<br><br>Find the value of the ${adjective} ${ctx.subject}.`;
                
                const w1 = parseFloat(((findLargest ? Math.min(a,b,c) : Math.max(a,b,c)) * k).toFixed(1));
                const w2 = parseFloat((Total / 3).toFixed(1)); 
                const w3 = parseFloat(((targetPart + 1) * k).toFixed(1));

                return {
                    q: "Word Problem:",
                    tex: qText,
                    correct: fmt(ansStr, ctx.unit),
                    distractors: [fmt(w1, ctx.unit), fmt(w2, ctx.unit), fmt(w3, ctx.unit)]
                };
            } 
            else if (type === 1) {
                // CHANGES
                const isPies = Math.random() > 0.5;
                let qText, correct, dists;
                
                if (isPies) {
                    const total = rand(40, 100);
                    const partA = Math.floor(total * (rand(1,3)/4)); 
                    const partB = total - partA;
                    
                    qText = `Betty made ${total} pies.<br><br>${partA} of them were chicken pies and the rest were apple pies.<br><br>Find the ratio of the number of apple pies to the number of chicken pies.`;
                    
                    correct = getSimplestRatio(partB, partA);
                    dists = [getSimplestRatio(partA, partB), getSimplestRatio(partB, total), getSimplestRatio(partA, total)];
                } else {
                    const roses = rand(10, 20);
                    const tulips = rand(10, 20);
                    const giveAway = rand(2, 5);
                    const newTulips = tulips - giveAway;
                    const newTotal = roses + newTulips;
                    
                    qText = `Lucy has ${roses} roses and ${tulips} tulips.<br><br>If she gives ${giveAway} tulips away, what is the ratio of the number of tulips to the total number of flowers now?`;
                    
                    correct = getSimplestRatio(newTulips, newTotal);
                    dists = [getSimplestRatio(tulips, roses + tulips), getSimplestRatio(newTulips, roses), getSimplestRatio(roses, newTotal)];
                }

                return {
                    q: "Ratio Application:",
                    tex: qText,
                    correct: correct,
                    distractors: dists
                };
            }
            else if (type === 2) {
                // MAP SCALE
                const mapDist = rand(2, 8); // cm
                const scaleK = rand(2, 10); // scale factor base
                const findScale = Math.random() > 0.5;
                
                if (findScale) {
                    const realDistM = mapDist * scaleK * 100; // in meters
                    const n = scaleK * 10000;
                    
                    const qText = `On a map, a length of ${mapDist} cm represents an actual distance of ${realDistM} m.<br><br>Find the scale of the map.<br><br><span class="text-xs text-gray-500 font-normal">(Hint: 1 km = 100,000 cm)</span>`;
                    
                    return {
                        q: "Map Scale:",
                        tex: qText,
                        correct: `1 : ${n}`,
                        distractors: [`1 : ${n/100}`, `1 : ${n*10}`, `1 : ${realDistM}`]
                    };
                } else {
                    const n = pick([5000, 10000, 20000, 50000]); 
                    const newMapDist = rand(4, 12) + (Math.random() > 0.5 ? 0.5 : 0);
                    const actualKm = (newMapDist * n) / 100000;
                    const qText = `The scale of a map is 1 : ${n}.<br><br>If a river is ${newMapDist} cm long on the map, find its actual length in km.<br><br><span class="text-xs text-gray-500 font-normal">(Hint: 1 km = 100,000 cm)</span>`;
                    
                    return {
                        q: "Map Scale:",
                        tex: qText,
                        correct: `${parseFloat(actualKm.toFixed(2))} \\text{ km}`,
                        distractors: [`${parseFloat((actualKm*10).toFixed(2))} \\text{ km}`, `${parseFloat((actualKm/10).toFixed(2))} \\text{ km}`, `${parseFloat((newMapDist).toFixed(2))} \\text{ km}`]
                    };
                }
            }
            else if (type === 3) {
                // REVENUE / TICKETS
                const p1 = 1000 * rand(2, 8);
                const p2 = 500 * rand(3, 9);
                const p3 = 100 * rand(5, 9);
                const r1 = rand(1, 4);
                const r2 = rand(2, 8);
                const r3 = rand(5, 15);
                const k = rand(5, 20);
                const revSubset = k * (r1 * p1 + r2 * p2);
                const totalTickets = k * (r1 + r2 + r3);
                
                const qText = `Tickets for a concert cost $${p1}, $${p2}, and $${p3} respectively.<br><br>The numbers of tickets sold are in the ratio ${r1} : ${r2} : ${r3}.<br><br>The revenue from the first two categories is $${revSubset.toLocaleString()}.<br><br>Find the total number of tickets sold.`;
                
                return {
                    q: "Problem Solving:",
                    tex: qText,
                    correct: `${totalTickets}`,
                    distractors: [`${totalTickets - k*r3}`, `${totalTickets + k}`, `${Math.floor(totalTickets * 1.5)}`]
                };
            }
            else if (type === 4) {
                // NEW: Algebraic ka = mb
                let k = rand(2, 5);
                let m = rand(2, 5);
                while (k === m) m = rand(2, 5);
                
                // Fixed formatting to mix HTML with MathJax delimiters
                const qText = `Given that:<br>$$${k}a = ${m}b$$<br>Find the ratio \\( a : b \\).`;
                const correct = getSimplestRatio(m, k);
                
                return {
                    q: "Algebraic Ratio:",
                    tex: qText,
                    correct: correct,
                    distractors: [getSimplestRatio(k, m), getSimplestRatio(k, k+m), getSimplestRatio(m, k+m)]
                };
            }
            else {
                // NEW: Algebraic a/k = b/m
                let k = rand(3, 9);
                let m = rand(3, 9);
                while (k === m) m = rand(3, 9);
                
                // Fixed formatting to mix HTML with MathJax delimiters
                const qText = `Given that:<br>$$ \\frac{a}{${k}} = \\frac{b}{${m}} $$<br>Find the ratio \\( a : b \\).`;
                const correct = getSimplestRatio(k, m);
                
                return {
                    q: "Algebraic Ratio:",
                    tex: qText,
                    correct: correct,
                    distractors: [getSimplestRatio(m, k), getSimplestRatio(k, k+m), getSimplestRatio(1, k*m)]
                };
            }
        }
    };

    // --- UI Functions ---

    function loadName() {
        const savedName = localStorage.getItem('hkdse_ratio_username');
        if (savedName) {
            document.getElementById('usernameInput').value = savedName;
            state.studentName = savedName;
        }
    }

    function saveName() {
        const name = document.getElementById('usernameInput').value.trim();
        if (name) {
            localStorage.setItem('hkdse_ratio_username', name);
            state.studentName = name;
        } else {
            state.studentName = "Student";
        }
    }

    function showMenu() {
        document.getElementById('menuView').classList.remove('hidden');
        document.getElementById('quizView').classList.add('hidden');
        document.getElementById('resultView').classList.add('hidden');
        document.getElementById('menuView').classList.add('fade-in');
    }

    function startQuiz(topic) {
        state.currentTopic = topic;
        state.score = 0;
        state.questionCount = 0;
        
        // Ensure name is updated
        const inputName = document.getElementById('usernameInput').value.trim();
        if(inputName) state.studentName = inputName;

        document.getElementById('score').textContent = '0';
        document.getElementById('qCount').textContent = '1';
        
        // Styling based on topic
        const header = document.getElementById('headerBar');
        const title = document.getElementById('quizTitle');
        const subtitle = document.getElementById('quizSubtitle');

        if (topic === 'simplify') {
            header.className = 'bg-indigo-600 p-5 text-white flex justify-between items-center shadow-md transition-colors duration-300';
            title.textContent = "Simplifying Ratios";
            subtitle.textContent = "Unit Conversions & Integers";
        } else if (topic === 'combined') {
            header.className = 'bg-pink-600 p-5 text-white flex justify-between items-center shadow-md transition-colors duration-300';
            title.textContent = "Combined Ratios";
            subtitle.textContent = "Linking two ratios";
        } else {
            header.className = 'bg-emerald-600 p-5 text-white flex justify-between items-center shadow-md transition-colors duration-300';
            title.textContent = "Application";
            subtitle.textContent = "Word Problems & Scales";
        }

        document.getElementById('menuView').classList.add('hidden');
        document.getElementById('quizView').classList.remove('hidden');
        document.getElementById('resultView').classList.add('hidden');
        
        generateQuestion();
    }

    function showResults() {
        document.getElementById('quizView').classList.add('hidden');
        document.getElementById('resultView').classList.remove('hidden');
        document.getElementById('resultView').classList.add('fade-in');

        document.getElementById('resultName').textContent = state.studentName;
        document.getElementById('resultScore').textContent = state.score;
        
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const dateString = now.toLocaleDateString();
        document.getElementById('resultTime').textContent = `${dateString} ${timeString}`;
    }

    function shuffle(array) {
        const unique = [...new Set(array)];
        for (let i = unique.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [unique[i], unique[j]] = [unique[j], unique[i]];
        }
        return unique;
    }

    function renderMath() {
        if (window.MathJax) {
            MathJax.typesetPromise([document.getElementById('mathDisplay'), document.getElementById('optionsGrid')])
                .catch((err) => console.log('MathJax error:', err));
        }
    }

    function generateQuestion() {
        if (state.questionCount >= state.maxQuestions) {
            showResults();
            return;
        }

        state.questionCount++;
        document.getElementById('qCount').textContent = state.questionCount;

        state.isAnswered = false;
        
        document.getElementById('feedbackArea').classList.add('hidden');
        document.getElementById('feedbackArea').classList.remove('animate-pulse');
        const nextBtn = document.getElementById('nextBtn');
        
        nextBtn.classList.remove('bg-green-600', 'hover:bg-green-700', 'shadow-green-300');
        nextBtn.classList.add('bg-slate-800', 'hover:bg-slate-900');
        nextBtn.innerHTML = `<span>${state.questionCount === state.maxQuestions ? 'Finish' : 'Skip / Next'}</span><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;

        const data = generators[state.currentTopic]();

        document.getElementById('questionText').textContent = data.q;
        
        const display = document.getElementById('mathDisplay');
        
        if (state.currentTopic === 'application') {
            display.classList.remove('text-4xl', 'text-center', 'text-3xl');
            display.classList.add('text-lg', 'text-left', 'font-normal'); 
            display.innerHTML = data.tex; // Inject HTML directly
        } else {
            display.classList.remove('text-lg', 'text-left', 'font-normal');
            display.classList.add('text-4xl', 'text-center');
            display.innerHTML = `$$${data.tex}$$`;
        }

        let pool = [data.correct, ...data.distractors];
        let uniquePool = [...new Set(pool)];
        while (uniquePool.length < 4) {
             uniquePool.push(`${rand(1,9)}`); 
        }
        if (!uniquePool.includes(data.correct)) uniquePool[0] = data.correct;
        
        let shuffledOpts = shuffle(uniquePool.slice(0, 4));

        const grid = document.getElementById('optionsGrid');
        grid.innerHTML = '';
        
        shuffledOpts.forEach(optText => {
            const btn = document.createElement('button');
            
            let hoverClass = 'hover:border-indigo-400';
            if (state.currentTopic === 'combined') hoverClass = 'hover:border-pink-400';
            if (state.currentTopic === 'application') hoverClass = 'hover:border-emerald-400';
            
            btn.className = `option-btn w-full bg-white border-2 border-slate-100 ${hoverClass} p-5 rounded-2xl text-lg font-medium text-slate-700 focus:outline-none relative overflow-hidden shadow-sm hover:shadow-md`;
            btn.innerHTML = `$$${optText}$$`;
            btn.dataset.correct = (optText === data.correct);
            btn.onclick = () => checkAnswer(btn);
            grid.appendChild(btn);
        });

        renderMath();
    }

    function checkAnswer(btn) {
        if (state.isAnswered) return;
        state.isAnswered = true;

        const isCorrect = btn.dataset.correct === "true";
        const allBtns = document.querySelectorAll('.option-btn');
        
        allBtns.forEach(b => {
            b.disabled = true;
            if (b.dataset.correct === "true") {
                b.classList.remove('bg-white', 'border-slate-100');
                b.classList.add('bg-green-50', 'border-green-500', 'text-green-800', 'shadow-md');
                b.innerHTML += '<div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-green-600 bg-white rounded-full p-1 shadow-sm"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>';
            } else {
                b.classList.add('opacity-50', 'scale-95');
            }
        });

        const feedback = document.getElementById('feedbackArea');
        feedback.classList.remove('hidden', 'bg-red-50', 'text-red-700', 'bg-green-50', 'text-green-700');

        if (isCorrect) {
            state.score++;
            feedback.classList.add('bg-green-50', 'text-green-700', 'border', 'border-green-200');
            feedback.textContent = "Correct! Well done.";
        } else {
            feedback.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-200');
            feedback.textContent = "Incorrect. The correct answer is highlighted above.";
            
            btn.classList.remove('opacity-50', 'scale-95');
            btn.classList.add('bg-red-50', 'border-red-500', 'text-red-800');
        }

        document.getElementById('score').textContent = state.score;

        const nextBtn = document.getElementById('nextBtn');
        nextBtn.classList.remove('bg-slate-800', 'hover:bg-slate-900');
        nextBtn.classList.add('bg-green-600', 'hover:bg-green-700', 'shadow-lg');
        
        const btnText = state.questionCount === state.maxQuestions ? 'View Results' : 'Next Question';
        
        nextBtn.innerHTML = `<span>${btnText}</span><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>`;
    }

    function nextQuestion() {
        generateQuestion();
    }
    
    window.onload = () => {
        loadName();
    };

</script>
</body>
</html>
